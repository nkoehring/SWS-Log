(function(){var Weblog,__slice=[].slice,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};Weblog=function(){Weblog.prototype.articles={};Weblog.prototype.tags={};Weblog.prototype.options={};Weblog.prototype.events={};Weblog.prototype.articleFilter="";Weblog.prototype.contentElement="content";Weblog.prototype.spinnerElement="spinner";Weblog.prototype.filterElement="filter";Weblog.prototype.filterResetElement="filter-reset";Weblog.prototype.articleTemplate='<article id="a{id}">\n  <a href="#{id}" class="title">\n    <span class="date">{date}</span>\n    <h2>{title}</h2>\n  </a>\n  <div id="c{id}" class="content">\n    <div class="info_block">\n      <div class="pretty_date">{date}</div>\n      <div class="author"><a href="http://about.me/nkoehring">nkoehring</a></div>\n      <ul id="t{id}" class="tags">{tags}</ul>\n    </div>\n  </div>\n  <div class="spinner">&nbsp;</div>\n</article>';Weblog.prototype.articleTagTemplate='<li><a href="#{tag}">{tag}</a></li>';Weblog.prototype.tagCloudTagTemplate='<li style="font-size:{size}"><a href="#{tag}">{tag}</a></li>';Weblog.prototype.bind=function(event,func){if(!this.events[event]){this.events[event]=[]}return this.events[event].push(func)};Weblog.prototype.unbind=function(event,func){if(!(event in this.events)){return false}return this.events[event].splice(this.events[event].indexOf(func),1)};Weblog.prototype.trigger=function(){var args,e,event,_i,_len,_ref,_results;event=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];if(!(event in this.events)){return false}_ref=this.events[event];_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){e=_ref[_i];_results.push(e.apply(this,args))}return _results};Weblog.prototype.filtered=function(stamp){var filter;filter=this.articleFilter.toLowerCase();if(filter.length===0){return false}if(filter.indexOf("tag:")===0){filter=filter.slice(4);return __indexOf.call(this.articles[stamp].tags.map("toLowerCase"),filter)<0}else{return this.articles[stamp].title.toLowerCase().indexOf(filter)<0}};Weblog.prototype.updateFilter=function(new_filter,tag){if(tag==null){tag=false}new_filter=new_filter.trim();if(new_filter.length>0){if(tag){this.filterElement.addClass("tag");this.filterElement.addClass("tag")}else{this.filterElement.removeClass("tag")}this.filterElement.update(new_filter);this.filterElement.show();this.filterResetElement.setStyle({display:"inline-block"});if(tag){new_filter="tag:"+new_filter}}else{this.filterElement.update("");this.filterElement.hide();this.filterResetElement.setStyle({display:"none"})}return this.articleFilter=new_filter};Weblog.prototype.clearContentArea=function(){return this.contentElement.clean()};Weblog.prototype.generateTagList=function(){var article,median,stamp,tag,template,total,unique,_i,_j,_len,_len1,_ref,_ref1,_ref2,_results;total=0;unique=0;median=0;this.tags=[];_ref=this.articles;for(stamp in _ref){article=_ref[stamp];if(this.filtered(stamp)){continue}_ref1=article.tags;for(_i=0,_len=_ref1.length;_i<_len;_i++){tag=_ref1[_i];total++;if(!(tag in this.tags)){this.tags[tag]=0;unique++}this.tags[tag]++}}median=total/unique;$("tags").clean();_ref2=Object.keys(this.tags).sort();_results=[];for(_j=0,_len1=_ref2.length;_j<_len1;_j++){tag=_ref2[_j];template=tpl(this.tagCloudTagTemplate,{tag:tag,size:1+(this.tags[tag]-median)/5+"em"});_results.push($("tags").append(template))}return _results};Weblog.prototype.filterForTag=function(tag){this.trigger("filter-update",tag,true);return this.trigger("article-update")};Weblog.prototype.addArticle=function(stamp,title,tags){var articleElement,article_tags,t,template,_i,_len;articleElement=$("a"+stamp);if(articleElement!=null){if(this.options.autoload){this.trigger("article-load",stamp)}return articleElement.show()}else{article_tags="";for(_i=0,_len=tags.length;_i<_len;_i++){t=tags[_i];article_tags+=tpl(this.articleTagTemplate,{tag:t})}template=tpl(this.articleTemplate,{id:stamp,title:title,date:prettyDate(new Date(parseInt(stamp)*1e3)),tags:article_tags});this.contentElement.append(template);if(this.options.autoload){return $$("#a"+stamp+" .spinner").show}}};Weblog.prototype.loadArticle=function(id){var articleElement,contentElement;if(this.articles[id].content!=null){return this.trigger("article-loaded",id)}else{articleElement=$("a"+id);contentElement=$("c"+id);return Xhr.load("articles/"+id,{onSuccess:function(_this){return function(req){_this.articles[id].content=textile(req.responseText,{breaks:false});contentElement.append(_this.articles[id].content);articleElement.removeClass("failure");articleElement.addClass("success");return _this.trigger("article-loaded",id)}}(this),onFailure:function(e,req){console.log("failed to load article "+id);articleElement.removeClass("success");articleElement.addClass("failure");return contentElement.append('<p class="error">Wasn\'t able to load this article :(</p>')}})}};Weblog.prototype.openArticle=function(id){var articleElement,contentElement;if(!this.options.autoload){this.trigger("article-load",id)}articleElement=$("a"+id);contentElement=$("c"+id);articleElement.addClass("open");contentElement.show("slide");return this.scrollFx.start({y:articleElement.position().y})};Weblog.prototype.update=function(){var stamp,_i,_len,_ref,_results;_ref=Object.keys(this.articles).sort().reverse();_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){stamp=_ref[_i];this.addArticle(stamp,this.articles[stamp].title,this.articles[stamp].tags);if(this.filtered(stamp)){_results.push($("a"+stamp).hide())}else{_results.push(void 0)}}return _results};Weblog.prototype.reset=function(){this.trigger("filter-update","");this.trigger("article-update");return this.closeArticles()};Weblog.prototype.closeArticles=function(){return $$("article.open").each(function(e,i){e.removeClass("open");return e.children(".content").each("hide")})};Weblog.prototype.checkFragment=function(e){var hash;this.reset();hash=location.hash.replace(" ","");if(hash.length>0){hash=hash.substring(1);if(hash in this.articles){return this.trigger("article-open",hash)}else if(hash in this.tags){return this.trigger("tags-list",hash)}else{return this.trigger("filter-update",hash)}}};function Weblog(){this.contentElement=$(this.contentElement);this.spinnerElement=$(this.spinnerElement);this.filterElement=$(this.filterElement);this.filterResetElement=$(this.filterResetElement);this.scrollFx=new Fx.Scroll(document.body);Xhr.Options.spinner=this.spinnerElement;this.clearContentArea();this.bind("article-update",this.update);this.bind("article-update",this.generateTagList);this.bind("article-load",this.loadArticle);this.bind("article-open",this.closeArticles);this.bind("article-open",this.openArticle);this.bind("tags-list",this.filterForTag);this.bind("filter-update",this.updateFilter);window.addEventListener("hashchange",this.checkFragment.bind(this));Xhr.load("articles.json?1393238683",{onSuccess:function(_this){return function(req){if(!req.responseJSON){req.responseJSON=JSON.parse(req.responseText)}_this.articles=req.responseJSON.articles;_this.options=req.responseJSON.options;_this.trigger("article-update");return _this.checkFragment()}}(this),onFailure:function(_this){return function(e,req){_this.contentElement.update("<h1>Failed to load articles!</h1>");return _this.contentElement.append("<p>"+req.status+" â€“ "+req.statusText+"</p>")}}(this)})}return Weblog}();$(document).onReady(function(){var body;body=$$("body").first();if(document.cookie==="theme=dark"){body.addClass("dark")}$$(".theme-selector").each("onClick",function(){var cookie,expiration,future;body.toggleClass("dark");if(body.hasClass("dark")){expiration=new Date;future=expiration.getTime()+60*60*24*365*1e3;expiration.setTime(future);cookie="theme=dark; expires="+expiration.toGMTString()}else{cookie="theme=; expires="+(new Date).toGMTString()}document.cookie=cookie;return console.log(cookie)});return window.weblog=new Weblog})}).call(this);